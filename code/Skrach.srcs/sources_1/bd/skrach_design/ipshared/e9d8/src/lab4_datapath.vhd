--------------------------------------------------------------------------------
-- Name:	Daria Solovey
-- Update:	2020/03/02
-- File:    lab4_datapath.vhd
-- HW:	    Lab 4
-- Pupr:	Datapath for lab4
--
-- Doc:	   Lab2, lectures
-- 	
-- Academic Integrity Statement: I certify that, while others may have 
-- assisted me in brain storming, debugging and validating this program, 
-- the program itself is my own work. I understand that submitting code 
-- which is the work of other individuals is a violation of the honor   
-- code.  I also understand that if I knowingly give my original work to 
-- another individual is also a violation of the honor code. 
--------------------------------------------------------------------------------


library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.NUMERIC_STD.ALL;
library UNIMACRO;
use unimacro.Vcomponents.all;
use work.lab4_parts.all;


entity lab4_datapath is
    Port (
        clk: in std_logic;
        reset_n: in std_logic;
        ac_mclk: out std_logic;
        ac_adc_sdata: in std_logic;
        ac_dac_sdata: out std_logic;
        ac_bclk: out std_logic;
        ac_lrclk: out std_logic;
        scl: inout std_logic;
        sda: inout std_logic;
        phase: in unsigned(15 downto 0);
        ampl: in unsigned(15 downto 0);
        sw: out std_logic;
        cw: in std_logic_vector(1 downto 0);
        waveSel: in std_logic
    );
end lab4_datapath;

architecture structure of lab4_datapath is
    signal ready, reset: std_logic;
    signal lBusIn, rBusIn: std_logic_vector(15 downto 0);
    signal count: unsigned(15 downto 0);
    signal readAddr: unsigned(9 downto 0);
    signal readSine, readChord: std_logic_vector(15 downto 0);
    signal signalOut, signalOutScaled: std_logic_vector(15 downto 0);
    signal counterCtrl: std_logic_vector (1 downto 0);

begin

    -----------------------------------------
    -- Control Unit Signals
    -----------------------------------------
    
    sw <= ready;
    counterCtrl <= cw;

    -----------------------------------------
    -- Audio Output
    -- Modified to output 16 bits.
    -----------------------------------------
    
    audio_inst: Audio_Codec_Wrapper port map (
        clk => clk,
        reset_n => reset_n,
        ac_mclk => ac_mclk,
        ac_adc_sdata => ac_adc_sdata,
        ac_dac_sdata => ac_dac_sdata,
        ac_bclk => ac_bclk,
        ac_lrclk => ac_lrclk,
        ready => ready,
        L_bus_in => lBusIn, -- left channel to outside
        R_bus_in => rBusIn, -- right channel to outside
        scl => scl,
        sda => sda
    );
    
    -----------------------------------------
    -- LUT
    -----------------------------------------
    
    reset <= not reset_n;

    ----------------------------------------------------------------------------
    -- Sine wave with a period of 2pi. Has a low base frequency and a high
    -- resolution. Base frequency is about 46.875 hz.
    ----------------------------------------------------------------------------
    bram_inst_sine: BRAM_SDP_MACRO generic map(
        BRAM_SIZE => "18Kb", 					-- Target BRAM, "18Kb" or "36Kb"
        DEVICE => "7SERIES", 					-- Target device: "VIRTEX5", "VIRTEX6", "SPARTAN6, 7SERIES"
        DO_REG => 0, 							-- Optional output register disabled
        INIT_00 => x"743B750375CC7694775D782578EE79B77A807B487C117CDA7DA37E6C7F357FFF",
        INIT_01 => x"67CB689169576A1D6AE36BA96C706D376DFE6EC56F8C7053711B71E372AB7373",
        INIT_02 => x"5B975C585D1A5DDB5E9D5F5F602260E561A8626B632F63F364B8657C66416706",
        INIT_03 => x"4FBD5078513251EE52AA5366542354E0559D565B571957D8589759575A175AD7",
        INIT_04 => x"445A450C45BF4672472647DA488F494549FB4AB14B684C204CD84D914E4A4F03",
        INIT_05 => x"398A3A323ADB3B843C2E3CD93D853E313EDE3F8B403940E84197424742F743A8",
        INIT_06 => x"2F67300430A1313F31DE327E331E33BF3461350435A7364B36F03795383B38E2",
        INIT_07 => x"260B269B272B27BC284E28E129752A0A2A9F2B352BCC2C642CFD2D962E302ECB",
        INIT_08 => x"1D8D1E0E1E901F131F97201C20A1212821AF223822C1234B23D6246224EF257D",
        INIT_09 => x"1602167316E5175917CD184218B9193019A81A211A9C1B171B931C101C8E1D0D",
        INIT_0A => x"0F7C0FDC103E10A01104116911CE1235129D1306137013DB144714B415231592",
        INIT_0B => x"0A0B0A5A0AAA0AFB0B4D0BA00BF40C490CA00CF80D500DAA0E050E610EBE0F1D",
        INIT_0C => x"05BD05FA0637067506B506F60738077B07BF0805084B089308DC0926097109BE",
        INIT_0D => x"029D02C602F0031C0348037603A503D50407043A046D04A204D9051005490582",
        INIT_0E => x"00B200C700DE00F6010F012A01450162018001A001C001E202050229024E0275",
        INIT_0F => x"0000000200050009000F0016001E00270031003D004A005800680078008A009D",
        INIT_10 => x"008A007800680058004A003D00310027001E0016000F00090005000200000000",
        INIT_11 => x"024E0229020501E201C001A0018001620145012A010F00F600DE00C700B2009D",
        INIT_12 => x"0549051004D904A2046D043A040703D503A503760348031C02F002C6029D0275",
        INIT_13 => x"0971092608DC0893084B080507BF077B073806F606B50675063705FA05BD0582",
        INIT_14 => x"0EBE0E610E050DAA0D500CF80CA00C490BF40BA00B4D0AFB0AAA0A5A0A0B09BE",
        INIT_15 => x"152314B4144713DB13701306129D123511CE1169110410A0103E0FDC0F7C0F1D",
        INIT_16 => x"1C8E1C101B931B171A9C1A2119A8193018B9184217CD175916E5167316021592",
        INIT_17 => x"24EF246223D6234B22C1223821AF212820A1201C1F971F131E901E0E1D8D1D0D",
        INIT_18 => x"2E302D962CFD2C642BCC2B352A9F2A0A297528E1284E27BC272B269B260B257D",
        INIT_19 => x"383B379536F0364B35A73504346133BF331E327E31DE313F30A130042F672ECB",
        INIT_1A => x"42F74247419740E840393F8B3EDE3E313D853CD93C2E3B843ADB3A32398A38E2",
        INIT_1B => x"4E4A4D914CD84C204B684AB149FB4945488F47DA4726467245BF450C445A43A8",
        INIT_1C => x"5A175957589757D85719565B559D54E05423536652AA51EE513250784FBD4F03",
        INIT_1D => x"6641657C64B863F3632F626B61A860E560225F5F5E9D5DDB5D1A5C585B975AD7",
        INIT_1E => x"72AB71E3711B70536F8C6EC56DFE6D376C706BA96AE36A1D6957689167CB6706",
        INIT_1F => x"7F357E6C7DA37CDA7C117B487A8079B778EE7825775D769475CC7503743B7373",
        INIT_20 => x"8BC28AFA8A31896988A087D8870F8646857D84B583EC8323825A819180C87FFE",
        INIT_21 => x"9832976C96A695E0951A9454938D92C691FF913890718FAA8EE28E1A8D528C8A",
        INIT_22 => x"A466A3A5A2E3A222A160A09E9FDB9F189E559D929CCE9C0A9B459A8199BC98F7",
        INIT_23 => x"B040AF85AECBAE0FAD53AC97ABDAAB1DAA60A9A2A8E4A825A766A6A6A5E6A526",
        INIT_24 => x"BBA3BAF1BA3EB98BB8D7B823B76EB6B8B602B54CB495B3DDB325B26CB1B3B0FA",
        INIT_25 => x"C673C5CBC522C479C3CFC324C278C1CCC11FC072BFC4BF15BE66BDB6BD06BC55",
        INIT_26 => x"D096CFF9CF5CCEBECE1FCD7FCCDFCC3ECB9CCAF9CA56C9B2C90DC868C7C2C71B",
        INIT_27 => x"D9F2D962D8D2D841D7AFD71CD688D5F3D55ED4C8D431D399D300D267D1CDD132",
        INIT_28 => x"E270E1EFE16DE0EAE066DFE1DF5CDED5DE4EDDC5DD3CDCB2DC27DB9BDB0EDA80",
        INIT_29 => x"E9FBE98AE918E8A4E830E7BBE744E6CDE655E5DCE561E4E6E46AE3EDE36FE2F0",
        INIT_2A => x"F081F021EFBFEF5DEEF9EE94EE2FEDC8ED60ECF7EC8DEC22EBB6EB49EADAEA6B",
        INIT_2B => x"F5F2F5A3F553F502F4B0F45DF409F3B4F35DF305F2ADF253F1F8F19CF13FF0E0",
        INIT_2C => x"FA40FA03F9C6F988F948F907F8C5F882F83EF7F8F7B2F76AF721F6D7F68CF63F",
        INIT_2D => x"FD60FD37FD0DFCE1FCB5FC87FC58FC28FBF6FBC3FB90FB5BFB24FAEDFAB4FA7B",
        INIT_2E => x"FF4BFF36FF1FFF07FEEEFED3FEB8FE9BFE7DFE5DFE3DFE1BFDF8FDD4FDAFFD88",
        INIT_2F => x"FFFDFFFBFFF8FFF4FFEEFFE7FFDFFFD6FFCCFFC0FFB3FFA5FF95FF85FF73FF60",
        INIT_30 => x"FF73FF85FF95FFA5FFB3FFC0FFCCFFD6FFDFFFE7FFEEFFF4FFF8FFFBFFFDFFFE",
        INIT_31 => x"FDAFFDD4FDF8FE1BFE3DFE5DFE7DFE9BFEB8FED3FEEEFF07FF1FFF36FF4BFF60",
        INIT_32 => x"FAB4FAEDFB24FB5BFB90FBC3FBF6FC28FC58FC87FCB5FCE1FD0DFD37FD60FD88",
        INIT_33 => x"F68CF6D7F721F76AF7B2F7F8F83EF882F8C5F907F948F988F9C6FA03FA40FA7B",
        INIT_34 => x"F13FF19CF1F8F253F2ADF305F35DF3B4F409F45DF4B0F502F553F5A3F5F2F63F",
        INIT_35 => x"EADAEB49EBB6EC22EC8DECF7ED60EDC8EE2FEE94EEF9EF5DEFBFF021F081F0E0",
        INIT_36 => x"E36FE3EDE46AE4E6E561E5DCE655E6CDE744E7BBE830E8A4E918E98AE9FBEA6B",
        INIT_37 => x"DB0EDB9BDC27DCB2DD3CDDC5DE4EDED5DF5CDFE1E066E0EAE16DE1EFE270E2F0",
        INIT_38 => x"D1CDD267D300D399D431D4C8D55ED5F3D688D71CD7AFD841D8D2D962D9F2DA80",
        INIT_39 => x"C7C2C868C90DC9B2CA56CAF9CB9CCC3ECCDFCD7FCE1FCEBECF5CCFF9D096D132",
        INIT_3A => x"BD06BDB6BE66BF15BFC4C072C11FC1CCC278C324C3CFC479C522C5CBC673C71B",
        INIT_3B => x"B1B3B26CB325B3DDB495B54CB602B6B8B76EB823B8D7B98BBA3EBAF1BBA3BC55",
        INIT_3C => x"A5E6A6A6A766A825A8E4A9A2AA60AB1DABDAAC97AD53AE0FAECBAF85B040B0FA",
        INIT_3D => x"99BC9A819B459C0A9CCE9D929E559F189FDBA09EA160A222A2E3A3A5A466A526",
        INIT_3E => x"8D528E1A8EE28FAA9071913891FF92C6938D9454951A95E096A6976C983298F7",
        INIT_3F => x"80C88191825A832383EC84B5857D8646870F87D888A089698A318AFA8BC28C8A",
        INIT_FILE => "NONE",					-- Not sure how to initialize the RAM from a file
        WRITE_WIDTH => 16, 						-- Valid values are 1-72 (37-72 only valid when BRAM_SIZE="36Kb")
        READ_WIDTH => 16, 						-- Valid values are 1-72 (37-72 only valid when BRAM_SIZE="36Kb")
        SIM_COLLISION_CHECK => "NONE", 			-- Collision check enable "ALL", "WARNING_ONLY", "GENERATE_X_ONLY" or "NONE"
        SRVAL => X"000000000000000000"			-- Set/Reset value for port output
    ) port map (
        DO => readSine,						    -- Output read data port, width defined by READ_WIDTH parameter
        DI => x"0000",                          -- Input to ram
        RDADDR => std_logic_vector(readAddr),   -- Input address, width defined by port depth
        RDCLK => clk,	 						-- 1-bit input clock
        RST => reset,							-- active high reset
        RDEN => '1',							-- read enable 
        REGCE => '1',							-- 1-bit input read output register enable - ignored
        WE => "11",					            -- since RAM is byte read, this determines high or low byte
        WRADDR => x"00" & b"00",                -- Write Address
        WRCLK => clk,							-- 1-bit input write clock
        WREN => '0'                             -- 1-bit input write port enable
    );
    
    ----------------------------------------------------------------------------
    -- A sine chord based on a minor 7 jazz chord. It does not oscilate,
    -- as the harmonics cause the amplitude to waver over a large period.
    -- A good period that happens to repeat well is about 20pi. Thus, the
    -- signal has a high starting frequency of about 500hz.
    ----------------------------------------------------------------------------
    bram_inst_chord: BRAM_SDP_MACRO generic map(
        BRAM_SIZE => "18Kb", 					-- Target BRAM, "18Kb" or "36Kb"
        DEVICE => "7SERIES", 					-- Target device: "VIRTEX5", "VIRTEX6", "SPARTAN6, 7SERIES"
        DO_REG => 0, 							-- Optional output register disabled
        INIT_00 => x"148C16EC1A1E1E2022ED287F2ECD35CC3D7245B14E7857B961606B5C75987FFF",
        INIT_01 => x"4D0446073F3B38B2327A2CA42740225C1E071A4D173B14DC13381259124512FF",
        INIT_02 => x"AA42A70EA3659F489ABB95C290638AA5848F7E2C778770AA69A462815B515422",
        INIT_03 => x"A96AAB58AD2BAEDAB05EB1ADB2BFB38DB40EB43AB40BB37AB282B11DAF48ACFF",
        INIT_04 => x"8E468F4D906C91A592F9946A95F7979F99619B3B9D299F28A133A346A559A768",
        INIT_05 => x"806781A682CD83DC84D685BC86928759881688CC897E8A328AEA8BAB8C798D56",
        INIT_06 => x"646D660B67C569956B756D616F5271447332751876F178BB7A717C127D9C7F0E",
        INIT_07 => x"65CE63F4625360ED5FC55EDD5E355DCE5DA85DC15E175EA85F70606D619962F0",
        INIT_08 => x"8E968C838A3F87D0853E828E7FC97CF67A1C7743747371B36F0A6C7F6A1867DB",
        INIT_09 => x"8D518F2990D8925793A094AE957C9608964D964C960295709496937792149073",
        INIT_0A => x"72A372FE73A1748875B0771178A77A6B7C567E60808182B084E5871989418B57",
        INIT_0B => x"8F7A8C9189A986CB840081527ECA7C6E7A48785B76AF75487429735572CD7292",
        INIT_0C => x"A137A2BAA3D5A487A4D1A4B4A435A357A220A0979EC19CA99A5697D195249259",
        INIT_0D => x"63E168406CC3715F76077AAE7F4783C788228C4C903B93E697449A4E9CFD9F4C",
        INIT_0E => x"50664E064C214ABE49DD498249AB4A584B844D2C4F4B51D854CC581F5BC55FB4",
        INIT_0F => x"997594F990398B43862480EB7BA7766571366C266745629E5E3F5A335684533D",
        INIT_10 => x"A2B0A5EDA8B9AB09ACD8AE20AEDCAF0BAEACADC0AC4AAA4DA7CFA4D8A1709DA1",
        INIT_11 => x"5BEB5F1162A5669B6AE66F78744179327E3C834F885A8D4E921B96B39B079F0A",
        INIT_12 => x"74CC6F666A5D65BD61935DEA5ACA583A564154E2542053F9546D55795716593F",
        INIT_13 => x"C744C4F1C1FABE69BA4CB5AFB0A2AB34A5789F7D995793178CCF869380737A80",
        INIT_14 => x"8D7995709D0BA43BAAEDB115B6A4BB90BFCEC357C625C833C980CA0BC9D8C8E9",
        INIT_15 => x"1B751EF9233F283C2DE434283AFA424749FF520F5A6362E66B85742B7CC38539",
        INIT_16 => x"4F9D475E3F8E383E317E2B5E25EB21301D391A0E17B61636159015C516D518BC",
        INIT_17 => x"D2CCCD5CC74BC0A4B972B1C3A9A5A127985A8F50861B7CCF737F6A3E6120583A",
        INIT_18 => x"CCC4D1A3D612DA06DD73E04DE28CE426E514E551E4D7E3A4E1B5DF0CDBABD794",
        INIT_19 => x"6D5C727177D07D73835189628F9C95F79C65A2DCA94FAFB2B5F5BC0DC1ECC782",
        INIT_1A => x"48A448C0491449A54A784B924CF74EAC50B4531155C758D75C41600564226895",
        INIT_1B => x"5652550D53D1529F517550544F3D4E314D334C444B674AA149F5496748FC48B9",
        INIT_1C => x"7625733270666DC16B4268E966B3649F62AB60D45F185D745BE65A6A58FF57A2",
        INIT_1D => x"B0FCAD7EA9D8A614A2389E4E9A5A966692778E948AC2870683647FE07C7E793F",
        INIT_1E => x"BF0AC123C2D1C411C4E2C546C53EC4CAC3F0C2B2C116BF20BCD7BA41B766B44C",
        INIT_1F => x"76EC7C30818A86EF8C5491B096F69C1DA11AA5E4AA70AEB7B2B1B655B99FBC87",
        INIT_20 => x"4848486548E749D04B204CD94EF9517F546757AE5B4F5F446385680D6CD171C9",
        INIT_21 => x"68A165F36335606E5DA75AE8583955A4533250EB4ED74CFF4B6B4A22492B488B",
        INIT_22 => x"7DD67DC57D977D457CCC7C277B537A4D791477A876087436723570076DB16B38",
        INIT_23 => x"848982DB816B80397F407E7F7DF07D8F7D557D3B7D3C7D517D717D957DB77DCF",
        INIT_24 => x"B690B34EAFE0AC54A8B5A50DA1679DCE9A4B96E693A790968DB88B1188A58678",
        INIT_25 => x"B444B867BBFABEF9C162C337C479C52BC552C4F4C417C2C4C104BEE1BC65B99C",
        INIT_26 => x"43D74B2852BF5A8B62786A75726F7A56821889A590EE97E59E7CA4A7AA5DAF94",
        INIT_27 => x"20AE1D141A48184F172B16DC176118B71AD81DBD215E25B02AA73035364C3CDD",
        INIT_28 => x"9F7496808D4F83F87A8F712967DC5EBC55DF4D58453A3D97367F30022A2E250E",
        INIT_29 => x"DCC5DED9E01BE086E018DECFDCAED9B7D5EFD15FCC10C60DBF64B822B058A818",
        INIT_2A => x"74FF7CA3847B8C7294769C72A451AC00B36ABA7DC124C750CCEED1F0D647D9E7",
        INIT_2B => x"41BC3FF33ED53E673EAE3FAC416143CD46EB4AB64F28543659D75FFD669B6DA1",
        INIT_2C => x"91B48C4D86A780D27ADE74DC6EDD68F2632D5D9D585453634ED74AC1472D4428",
        INIT_2D => x"A8D6AB63AD75AF02B006B07BB05EAFAEAE6AAC95AA32A746A3D69FEC9B9196D0",
        INIT_2E => x"62CC66C16AFE6F7A742778FA7DE782DF87D58CBB918496209A839EA0A26AA5D4",
        INIT_2F => x"5AAB582255EB54115298518750E350B050F151A652D0546E567E58FB5BE15F29",
        INIT_30 => x"91868EC08BC0888B8527819D7DF37A32766372916EC46B07676563E760975D80",
        INIT_31 => x"9AD29BD69CB89D749E029E5F9E849E6D9E169D7C9C9D9B769A0798509651940D",
        INIT_32 => x"8A6D8AE08B6E8C188CDD8DBE8EB78FC790EB9220936294AB95F79740988299B4",
        INIT_33 => x"882988B18917895F898D89A689AE89AB89A08994898A8988899189A989D48A14",
        INIT_34 => x"6AD36D80702572BD754077A979F47C1D7E1F7FF981A8832A848085AA86A8877D",
        INIT_35 => x"524451D351BA51F752875366548F55FE57AC59945BAE5DF3605C62E2657C6825",
        INIT_36 => x"812E7CEE78B5748D70806C9568D5654A61F95EEB5C2459AA578155AE5431530E",
        INIT_37 => x"ADE6AD5BAC75AB33A996A7A0A555A2B99FD19CA39935958F91B88DBB899E856C",
        INIT_38 => x"927E952097CA9A729D0F9F9AA209A453A671A85BAA08AB73AC96AD69ADEAAE15",
        INIT_39 => x"7E117DCC7DB57DD27E267EB27F7A807C81BA833184DF86C088D18B0D8D6C8FEA",
        INIT_3A => x"84A9855685BE85E585D1858A8516847E83C98300822C815580837FBF7F117E7F",
        INIT_3B => x"54E0591E5D5C618E65A8699F6D6A7100745977707A3E7CC17EF580D9826D83B1",
        INIT_3C => x"395E3726359834B0346934BE35A5371639083B6E3E3E416944E548A24C9450AD",
        INIT_3D => x"A7D89E9A955F8C3A833F7A7F720D69F8624F5B2154794E6248E444063FCF3C41",
        INIT_3E => x"FFBDFFFEFF4AFDA6FB19F7AAF366EE57E88BE213DAFFD361CB4BC2D1BA08B103",
        INIT_3F => x"8B6996BCA1E0ACBDB73DC14ACAD1D3BEDBFEE382EA3BF01DF51DF932FC56FE85",
        INIT_FILE => "NONE",					-- Not sure how to initialize the RAM from a file
        WRITE_WIDTH => 16, 						-- Valid values are 1-72 (37-72 only valid when BRAM_SIZE="36Kb")
        READ_WIDTH => 16, 						-- Valid values are 1-72 (37-72 only valid when BRAM_SIZE="36Kb")
        SIM_COLLISION_CHECK => "NONE", 			-- Collision check enable "ALL", "WARNING_ONLY", "GENERATE_X_ONLY" or "NONE"
        SRVAL => X"000000000000000000"			-- Set/Reset value for port output
    ) port map (
        DO => readChord,						-- Output read data port, width defined by READ_WIDTH parameter
        DI => x"0000",                          -- Input to ram
        RDADDR => std_logic_vector(readAddr),   -- Input address, width defined by port depth
        RDCLK => clk,	 						-- 1-bit input clock
        RST => reset,							-- active high reset
        RDEN => '1',							-- read enable 
        REGCE => '1',							-- 1-bit input read output register enable - ignored
        WE => "11",					            -- since RAM is byte read, this determines high or low byte
        WRADDR => x"00" & b"00",                -- Write Address
        WRCLK => clk,							-- 1-bit input write clock
        WREN => '0'                             -- 1-bit input write port enable
    );
    
    -----------------------------------------
    -- Read address / phase logic
    -----------------------------------------
    
    counter_inst: addr_counter port map (
        clk => clk,
        reset_n => reset_n,
        cw => counterCtrl,
        D => phase,
        count => count
    );
    
    readAddr <= count(15 downto 6);
    
    -----------------------------------------
    -- Amplitude and sign shift
    -- Signal Select and output
    -----------------------------------------
    
    signalOut <= readChord when waveSel = '1' else readSine;
    
    signalOutScaled <= std_logic_vector((unsigned(signalOut) / ampl) - 32767);
    
    lBusIn <= signalOutScaled;
    rBusIn <= signalOutScaled;

end structure;